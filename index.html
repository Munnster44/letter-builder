<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Letter Builder v2.0-PWA</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- PWA Manifest -->
<link rel="manifest" href="manifest.json">

<style>
    body {
        font-family: Calibri, sans-serif;
        margin: 30px;
        background: #f7f7f7;
    }

    #appContainer {
        background: white;
        padding: 25px;
        border-radius: 12px;
        max-width: 900px;
        margin: auto;
        box-shadow: 0 0 12px rgba(0,0,0,0.15);
    }

    #logo {
        display: block;
        margin: auto;
        height: 60px;
    }

    h2 {
        text-align: center;
        margin-bottom: 10px;
    }

    label {
        font-weight: bold;
        margin-top: 12px;
        display: block;
    }

    select, textarea {
        width: 100%;
        padding: 8px;
        margin-top: 5px;
        border-radius: 6px;
        border: 1px solid #888;
        font-size: 15px;
    }

    textarea {
        height: 160px;
    }

    button {
        margin-top: 18px;
        padding: 12px 22px;
        border: none;
        background: #0066cc;
        color: white;
        border-radius: 6px;
        font-size: 16px;
        cursor: pointer;
    }

    button:hover {
        background: #004c99;
    }

    .footer {
        margin-top: 30px;
        text-align: center;
        font-size: 13px;
        color: #666;
    }
</style>

<!-- SheetJS + JSZip -->
<script src="xlsx.full.min.js"></script>
<script src="jszip.min.js"></script>

</head>
<body>
<div id="appContainer">
<!-- ============================
     PART 2 — APP LAYOUT + UI
     ============================ -->

<!-- Logo -->
<img id="logo" src="logo.png" alt="CanBoat / NautiSavoir Logo">

<h2>Letter Builder v2.0-PWA</h2>

<!-- Excel File Input -->
<label>Select Membership Excel File:</label>
<input type="file" id="excelFile" accept=".xlsx">

<!-- TO Person -->
<label>To:</label>
<select id="toPerson"></select>

<!-- FROM Person -->
<label>From:</label>
<select id="fromPerson"></select>

<!-- Body Text -->
<label>Letter Body:</label>
<textarea id="letterBody" placeholder="Enter letter content here..."></textarea>

<!-- Generate Button -->
<button onclick="generateDOCX()">Generate DOCX Letter</button>

<hr style="margin-top:30px;">

<div class="footer">
    Letter Builder v2.0-PWA — © 2025 CanBoat / NautiSavoir
</div>

<script>
/* ==========================================
   PART 2 — INITIAL VARIABLES + SAFE STRING
   ========================================== */

let members = [];

/* SAFE STRING CONVERTER
   Prevents ALL Word XML crashes (undefined, null, numbers)
*/
const X = t => String(t ?? "")
  .replace(/&/g,"&amp;")
  .replace(/</g,"&lt;")
  .replace(/>/g,"&gt;");
/* ==========================================
   PART 3 — EXCEL LOADING + DROPDOWN BUILDER
   ========================================== */

/* When Excel file is selected */
excelFile.addEventListener("change", e => {
    const reader = new FileReader();
    reader.onload = ev => {
        const workbook = XLSX.read(new Uint8Array(ev.target.result), { type: "array" });

        // Load ONLY first sheet into JSON array
        members = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);

        loadDropdowns();
    };
    reader.readAsArrayBuffer(e.target.files[0]);
});

/* Build the TO / FROM dropdown lists */
function loadDropdowns() {
    toPerson.innerHTML = "";
    fromPerson.innerHTML = "";

    members.forEach((m, i) => {
        let label = `${X(m["Last Name"] || "")}, ${X(m["First Name"] || "")} — ${X(m["Member ID"] || "")}`;

        toPerson.innerHTML += `<option value="${i}">${label}</option>`;
        fromPerson.innerHTML += `<option value="${i}">${label}</option>`;
    });
}

/* Wrap plain text into Word paragraph */
function p(t) {
    return `<w:p><w:r><w:t>${X(t)}</w:t></w:r></w:p>`;
}

/* Address block generator */
function addr(m) {
    let a1 = X(m["Address 1"] || "");
    let a2 = X(m["Address 2"] || "");
    let merged = a2 ? `${a1}, ${a2}` : a1;

    return [
        merged,
        X((m["City"] || "") + " " + (m["Province"] || "")),
        X((m["Country"] || "") + " " + (m["Postal Code"] || ""))
    ];
}
/* ======================================================
   PART 4 — FULL DOCX GENERATOR (WORD-COMPLIANT OPC ZIP)
   ====================================================== */

async function generateDOCX() {

    const to = members[toPerson.value];
    const fr = members[fromPerson.value];
    const bodyLines = letterBody.value.split("\n").map(X);
    const dateStr = new Date().toLocaleDateString('en-US',
        {year:'numeric', month:'long', day:'numeric'});

    /* Load the logo */
    const logoBinary = await fetch("logo.png").then(r=>r.arrayBuffer());

    /* Build the main Word document.xml content */
    let documentXML = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:document
 xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main"
 xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships">
<w:body>

${p(X(dateStr))}

${p("To:")}
${p(X((to["First Name"]||"") + " " + (to["Last Name"]||"")))}
${addr(to).map(l=>p(l)).join("")}
${p("Member ID: " + X(to["Member ID"]||""))}
${p("Next Payment Date: " + X(to["Next Payment Date"]||""))}

${p("From:")}
${p(X((fr["First Name"]||"") + " " + (fr["Last Name"]||"")))}
${addr(fr).map(l=>p(l)).join("")}

${p("Sincerely,")}
${p(X((fr["First Name"]||"") + " " + (fr["Last Name"]||"")))}
${p("Email: " + X(fr["Email"]||""))}
${p("Home Phone: " + X(fr["Home Phone"]||""))}

${bodyLines.map(l=>p(l)).join("")}

<w:p>
   <w:r>
      <w:t>CanBoat / NautiSavoir — Letter Builder v2.0-PWA</w:t>
   </w:r>
</w:p>

</w:body>
</w:document>`;

    /* CREATE ZIP (DOCX) */
    const zip = new JSZip();

    /* =============================
       [Content_Types].xml (REQUIRED)
       ============================= */
    zip.file("[Content_Types].xml",
`<?xml version="1.0" encoding="UTF-8"?>
<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
 <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
 <Default Extension="xml" ContentType="application/xml"/>
 <Default Extension="png" ContentType="image/png"/>

 <Override PartName="/word/document.xml"
   ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>

 <Override PartName="/docProps/core.xml"
   ContentType="application/vnd.openxmlformats-package.core-properties+xml"/>

 <Override PartName="/docProps/app.xml"
   ContentType="application/vnd.openxmlformats-officedocument.extended-properties+xml"/>

 <Override PartName="/word/styles.xml"
   ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.styles+xml"/>

 <Override PartName="/word/settings.xml"
   ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.settings+xml"/>

 <Override PartName="/word/fontTable.xml"
   ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.fontTable+xml"/>

 <Override PartName="/word/theme/theme1.xml"
   ContentType="application/vnd.openxmlformats-officedocument.theme+xml"/>
</Types>`);

    /* =============================
       _rels/.rels
       ============================= */
    zip.folder("_rels").file(".rels",
`<?xml version="1.0" encoding="UTF-8"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
 <Relationship Id="rId1"
    Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument"
    Target="word/document.xml"/>

 <Relationship Id="rId2"
    Type="http://schemas.openxmlformats.org/package/2006/relationships/metadata/core-properties"
    Target="docProps/core.xml"/>

 <Relationship Id="rId3"
    Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/extended-properties"
    Target="docProps/app.xml"/>
</Relationships>`);

    /* =============================
       docProps/core.xml
       ============================= */
    zip.folder("docProps").file("core.xml",
`<?xml version="1.0" encoding="UTF-8"?>
<cp:coreProperties
 xmlns:cp="http://schemas.openxmlformats.org/package/2006/metadata/core-properties"
 xmlns:dc="http://purl.org/dc/elements/1.1/">
 <dc:title>Letter Builder v2.0-PWA</dc:title>
 <dc:creator>CanBoat / NautiSavoir</dc:creator>
</cp:coreProperties>`);

    /* =============================
       docProps/app.xml
       ============================= */
    zip.folder("docProps").file("app.xml",
`<?xml version="1.0" encoding="UTF-8"?>
<Properties
 xmlns="http://schemas.openxmlformats.org/officeDocument/2006/extended-properties"
 xmlns:vt="http://schemas.openxmlformats.org/officeDocument/2006/docPropsVTypes">
 <Application>Letter Builder v2.0</Application>
 <DocSecurity>0</DocSecurity>
</Properties>`);

    /* =============================
       word/document.xml
       ============================= */
    zip.folder("word").file("document.xml", documentXML);

    /* =============================
       word/styles.xml
       ============================= */
    zip.folder("word").file("styles.xml",
`<?xml version="1.0" encoding="UTF-8"?>
<w:styles xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
 <w:style w:type="paragraph" w:default="1" w:styleId="Normal">
   <w:name w:val="Normal"/>
   <w:rPr>
     <w:rFonts w:ascii="Calibri" w:hAnsi="Calibri"/>
     <w:sz w:val="22"/>
   </w:rPr>
 </w:style>
</w:styles>`);

    /* =============================
       word/settings.xml
       ============================= */
    zip.folder("word").file("settings.xml",
`<?xml version="1.0" encoding="UTF-8"?>
<w:settings xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
 <w:defaultTabStop w:val="720"/>
</w:settings>`);

    /* =============================
       word/fontTable.xml
       ============================= */
    zip.folder("word").file("fontTable.xml",
`<?xml version="1.0" encoding="UTF-8"?>
<w:fonts xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
 <w:font w:name="Calibri"/>
</w:fonts>`);

    /* =============================
       word/theme/theme1.xml
       ============================= */
    zip.folder("word").folder("theme").file("theme1.xml",
`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<a:theme xmlns:a="http://schemas.openxmlformats.org/drawingml/2006/main" name="Office Theme"></a:theme>`);

    /* =============================
       word/_rels/document.xml.rels
       ============================= */
    zip.folder("word/_rels").file("document.xml.rels",
`<?xml version="1.0" encoding="UTF-8"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
 <Relationship Id="rIdLogo"
    Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/image"
    Target="media/logo.png"/>
</Relationships>`);

    /* =============================
       word/media/logo.png
       ============================= */
    zip.folder("word/media").file("logo.png", logoBinary);

    /* =============================
       FINAL ZIP = DOCX
       ============================= */
    const blob = await zip.generateAsync({type:"blob"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `Letter_${to["Last Name"]||"Member"}_${new Date().toISOString().slice(0,10)}.docx`;
    a.click();
}
</script>
/* ==========================================
   PART 5 — MANIFEST + SERVICE WORKER (PWA)
   ========================================== */

/* Create & inject manifest dynamically */
const manifestData = {
    "name": "Letter Builder v2.0-PWA",
    "short_name": "LetterBuilder",
    "start_url": "./",
    "display": "standalone",
    "background_color": "#ffffff",
    "theme_color": "#0066cc",
    "icons": [
        {
            "src": "logo.png",
            "sizes": "256x256",
            "type": "image/png"
        }
    ]
};

const manifestBlob = new Blob([JSON.stringify(manifestData)], { type: "application/json" });
const manifestURL = URL.createObjectURL(manifestBlob);
document.querySelector('link[rel="manifest"]').setAttribute("href", manifestURL);

/* SERVICE WORKER REGISTRATION (auto-generated SW) */
const swCode = `
self.addEventListener('install', event => {
    self.skipWaiting();
    event.waitUntil(
        caches.open('letterbuilder-v2').then(cache => {
            return cache.addAll(['./', 'logo.png']);
        })
    );
});

self.addEventListener('activate', event => {
    clients.claim();
});

self.addEventListener('fetch', event => {
    event.respondWith(
        caches.match(event.request).then(resp => {
            return resp || fetch(event.request);
        })
    );
});
`;

const swBlob = new Blob([swCode], { type: "application/javascript" });
const swURL = URL.createObjectURL(swBlob);

/* Register SW */
if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register(swURL)
        .catch(err => console.error("SW registration failed:", err));
}

</script>

</div> <!-- END appContainer -->
</body>
</html>
