<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Letter Builder v1.10-PWA</title>

<script src="xlsx.full.min.js"></script>
<script src="jszip.min.js"></script>

<style>
body { font-family: Calibri, sans-serif; margin: 40px; }
textarea { width: 100%; height: 150px; }
h2 { text-align: center; }
</style>
</head>
<body>

<h2>Letter Builder v1.10-PWA</h2>

<input type="file" id="excelFile" accept=".xlsx"><br><br>

<label>To:</label><br>
<select id="toPerson"></select><br><br>

<label>From:</label><br>
<select id="fromPerson"></select><br><br>

<label>Letter Body:</label><br>
<textarea id="letterBody"></textarea><br><br>

<button onclick="generateDOCX()">Generate DOCX</button>

<script>
// ================================
// UTILITIES
// ================================
let members = [];

function X(t){
    return String(t ?? "")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;");
}

function P(text){
    return "<w:p><w:r><w:t xml:space=\"preserve\">" + X(text) + "</w:t></w:r></w:p>";
}

// Merge Address1 + Address2 (comma if Address2 exists)
function mergeAddress(m){
    const a1 = m["Address 1"] || "";
    const a2 = m["Address 2"] || "";
    return a2 ? (a1 + ", " + a2) : a1;
}

// ================================
// LOAD EXCEL
// ================================
excelFile.addEventListener("change", e => {
    const r = new FileReader();
    r.onload = ev => {
        const wb = XLSX.read(new Uint8Array(ev.target.result), { type:"array" });
        members = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
        loadDropdowns();
    };
    r.readAsArrayBuffer(e.target.files[0]);
});

function loadDropdowns(){
    toPerson.innerHTML = "";
    fromPerson.innerHTML = "";
    members.forEach((m,i)=>{
        const lbl = (m["Last Name"]||"") + ", " +
                    (m["First Name"]||"") + " â€” " +
                    (m["Member ID"]||"");
        toPerson.innerHTML += "<option value='"+i+"'>"+lbl+"</option>";
        fromPerson.innerHTML += "<option value='"+i+"'>"+lbl+"</option>";
    });
}

// ================================
// MAIN DOCX GENERATOR (v1.10)
// ================================
async function generateDOCX(){

    const to = members[toPerson.value];
    const fr = members[fromPerson.value];
    const bodyLines = letterBody.value.split("\n");

    const dateStr = new Date().toLocaleDateString(
        'en-US',
        {year:"numeric", month:"long", day:"numeric"}
    );

    // Load logo binary
    const logoBinary = await fetch("logo.png").then(r => r.arrayBuffer());

    // -----------------------------
    // BUILD XML LINE-BY-LINE
    // -----------------------------
    let xml = [];

    xml.push('<?xml version="1.0" encoding="UTF-8" standalone="yes"?>');
    xml.push('<w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main"');
    xml.push(' xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships">');
    xml.push('<w:body>');

    // ===========================================
    // CENTERED LOGO AT TOP
    // ===========================================
    xml.push('<w:p><w:pPr><w:jc w:val="center"/></w:pPr><w:r><w:drawing>');
    xml.push('<wp:inline xmlns:wp="http://schemas.openxmlformats.org/drawingml/2006/wordprocessingDrawing"');
    xml.push(' distT="0" distB="0" distL="0" distR="0">');
    xml.push('<wp:extent cx="2500000" cy="600000"/>');
    xml.push('<wp:docPr id="1" name="Logo"/>');
    xml.push('<a:graphic xmlns:a="http://schemas.openxmlformats.org/drawingml/2006/main">');
    xml.push('<a:graphicData uri="http://schemas.openxmlformats.org/drawingml/2006/picture">');
    xml.push('<pic:pic xmlns:pic="http://schemas.openxmlformats.org/drawingml/2006/picture">');
    xml.push('<pic:blipFill><a:blip r:embed="rId5"/></pic:blipFill>');
    xml.push('<pic:spPr/></pic:pic></a:graphicData></a:graphic>');
    xml.push('</wp:inline></w:drawing></w:r></w:p>');

    // ===========================================
    // LETTER CONTENT
    // ===========================================
    xml.push(P(dateStr));
    xml.push(P("To:"));
    xml.push(P((to["First Name"]||"") + " " + (to["Last Name"]||"")));

    xml.push(P(mergeAddress(to)));
    xml.push(P((to["City"]||"") + " " + (to["Province"]||"")));
    xml.push(P((to["Country"]||"") + " " + (to["Postal Code"]||"")));

    xml.push(P("Member ID: " + (to["Member ID"]||"")));
    xml.push(P("Next Payment Date: " + (to["Next Payment Date"]||"")));

    xml.push(P("")); // spacer

    // Body BEFORE closing
    bodyLines.forEach(line => {
        xml.push(P(line));
    });

    xml.push(P("")); // spacer

    xml.push(P("Sincerely,"));
    xml.push(P((fr["First Name"]||"") + " " + (fr["Last Name"]||"")));
    xml.push(P("Email: " + (fr["Email"]||"")));
    xml.push(P("Home Phone: " + (fr["Home Phone"]||"")));

    // ===========================================
    // REQUIRED SECTION PROPERTIES
    // ===========================================
    xml.push('<w:sectPr>');
    xml.push('<w:pgSz w:w="12240" w:h="15840"/>');
    xml.push('<w:pgMar w:top="1440" w:right="1440" w:bottom="1440" w:left="1440"/>');
    xml.push('</w:sectPr>');
    xml.push('</w:body></w:document>');

    const docXML = xml.join("");

    // -----------------------------
    // BUILD ZIP PACKAGE
    // -----------------------------
    const zip = new JSZip();

    // content types
    zip.file("[Content_Types].xml",
'<?xml version="1.0" encoding="UTF-8"?>\
<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">\
  <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>\
  <Default Extension="xml"  ContentType="application/xml"/>\
  <Default Extension="png"  ContentType="image/png"/>\
  <Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>\
  <Override PartName="/docProps/core.xml" ContentType="application/vnd.openxmlformats-package.core-properties+xml"/>\
  <Override PartName="/docProps/app.xml"  ContentType="application/vnd.openxmlformats-officedocument.extended-properties+xml"/>\
</Types>');

    // root rels
    zip.folder("_rels").file(".rels",
'<?xml version="1.0" encoding="UTF-8"?>\
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">\
  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/>\
  <Relationship Id="rId2" Type="http://schemas.openxmlformats.org/package/2006/relationships/metadata/core-properties" Target="docProps/core.xml"/>\
  <Relationship Id="rId3" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/extended-properties" Target="docProps/app.xml"/>\
</Relationships>');

    // core metadata
    zip.folder("docProps").file("core.xml",
'<?xml version="1.0" encoding="UTF-8"?>\
<cp:coreProperties xmlns:cp="http://schemas.openxmlformats.org/package/2006/metadata/core-properties"\
 xmlns:dc="http://purl.org/dc/elements/1.1/">\
  <dc:title>Letter</dc:title>\
  <dc:creator>Letter Builder v1.10</dc:creator>\
</cp:coreProperties>');

    // app metadata
    zip.folder("docProps").file("app.xml",
'<?xml version="1.0" encoding="UTF-8"?>\
<Properties xmlns="http://schemas.openxmlformats.org/officeDocument/2006/extended-properties"\
 xmlns:vt="http://schemas.openxmlformats.org/officeDocument/2006/docPropsVTypes">\
  <Application>Letter Builder v1.10</Application>\
  <Pages>1</Pages>\
</Properties>');

    // word/document.xml
    zip.folder("word").file("document.xml", docXML);

    // document relationships
    zip.folder("word/_rels").file("document.xml.rels",
'<?xml version="1.0" encoding="UTF-8"?>\
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">\
  <Relationship Id="rId5" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/image" Target="media/logo.png"/>\
</Relationships>');

    // media/logo.png
    zip.folder("word/media").file("logo.png", logoBinary);

    // -----------------------------
    // SAVE FILE
    // -----------------------------
    const suggested =
        "Letter_" + String(to["Last Name"]||"").replace(/ /g,"_") +
        "_" + new Date().toISOString().slice(0,10) + ".docx";

    const filename = prompt("Enter filename:", suggested) || suggested;

    const blob = await zip.generateAsync({ type:"blob" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
}
</script>

</body>
</html>
